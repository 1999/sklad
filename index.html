<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <script src="https://npmcdn.com/sklad@latest/dist/sklad.min.js"></script>

    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://yastatic.net/share/cnt.share.js"></script>
    <script type="text/javascript">
    window.onload = function () {
        function log(outputElem, text) {
            var lastOperationTS = Number(outputElem.dataset.lots) || Date.now();
            var diffMSec = Date.now() - lastOperationTS;
            var passedMSec = diffMSec ? '+' + diffMSec : 0;

            outputElem.innerHTML += '[' + passedMSec + 'ms] ' + text + '\n';
            outputElem.scrollTop = outputElem.scrollHeight;

            outputElem.dataset.lots = Date.now();
        };

        function runExample(id) {
            var output = document.querySelector('#' + id);
            var btn = document.querySelector('button[data-id="' + id + '"]');

            output.style.display = 'block';
            btn.style.display = 'none';

            var dbName = 'dbName_' + Date.now();
            log(output, 'Start with database "' + dbName + '"');

            sklad.open(dbName, {
                version: 2,
                migration: {
                    '1': function (database) {
                        log(output, 'Start executing migration scripts');

                        // This migration part starts when your code runs first time in the browser.
                        // This is a migration from "didn't exist" to "1" database version
                        var objStore = database.createObjectStore('users', {autoIncrement: true});
                        objStore.createIndex('email_search', 'email', {unique: true});
                        objStore.createIndex('name_search', 'firstname');
                    },
                    '2': function (database) {
                        // This migration part starts when your database migrates from "1" to "2" version
                        var objStore = database.createObjectStore('foo_obj_store', {keyPath: 'foo'});

                        log(output, 'Migration scripts finished');
                    }
                }
            }).then(function (conn) {
                log(output, 'Connected to database');

                if (id === 'sklad_open') {
                    return;
                }

                if (id === 'conn_close') {
                    conn.close();
                    log(output, 'Connected closed');

                    return
                }

                var words = 'Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.'.split(' ');
                var data = {
                    users: [
                        {email: 'example1@gmail.com', firstname: 'John'},
                        {email: 'example2@gmail.com', firstname: 'Jack'},
                        {email: 'example3@gmail.com', firstname: 'Peter'},
                    ],
                    foo_obj_store: words.map(function (word) { return {foo: word}; })
                };

                log(output, 'Start insert operation with data: ' + JSON.stringify(data));

                conn.insert(data).then(function (insertedKeys) {
                    log(output, 'Inserted keys: ' + JSON.stringify(insertedKeys));

                    switch (id) {
                        case 'conn_upsert':
                            var data = {
                                foo_obj_store: words.map(function (word) { return {foo: word, some_new_field: Math.random()}; })
                            };

                            log(output, 'Start upsert operation with data: ' + JSON.stringify(data));

                            conn.upsert(data).then(function (upsertedKeys) {
                                log(output, 'Upserted keys: ' + JSON.stringify(upsertedKeys));
                            }).catch(function (err) {
                                throw new Error(err.message);
                            });

                            break;

                        case 'conn_delete':
                            var data = {
                                foo_obj_store: words.filter(function (word) { return (Math.random() > 0.5); })
                            };

                            log(output, 'Start delete operation with data: ' + JSON.stringify(data));

                            conn.delete(data).then(function () {
                                log(output, 'Delete operation finished');
                            }).catch(function (err) {
                                throw new Error(err.message);
                            });

                            break;

                        case 'conn_clear':
                            log(output, 'Start clear object stores operation');

                            conn.clear(['users', 'foo_obj_store']).then(function () {
                                log(output, 'Clear operation finished');
                            }).catch(function (err) {
                                throw new Error(err.message);
                            });

                            break;

                        case 'conn_get':
                            log(output, 'Start get operation');

                            conn.get({
                                users: {direction: sklad.DESC, index: 'name_search'},
                                foo_obj_store: {offset: 10, limit: 5}
                            }).then(function (data) {
                                log(output, 'Get operation finished: ' + JSON.stringify(data));
                            }).catch(function (err) {
                                throw new Error(err.message);
                            });

                            break;

                        case 'conn_count':
                            log(output, 'Count number of records between A and l')

                            conn.count('foo_obj_store', {range: IDBKeyRange.bound('A', 'l')}).then(function (total) {
                                log(output, 'Count operation finished. Total records between "A" and "l" is: ' + total);
                            }).catch(function (err) {
                                throw new Error(err.message);
                            });

                        case 'conn_close':
                            break;
                    }
                }).catch(function (err) {
                    throw new Error(err.message);
                });
            });
        };

        var btns = document.querySelectorAll("button[data-id]");
        for (var i = 0; i < btns.length; i++) {
            btns[i].onclick = function () {
                runExample(this.dataset.id);
            };
        }
    };
    </script>

    <style type="text/css">
      body {
        padding-top: 20px;
        padding-bottom: 40px;
      }

      pre.example {
        max-height: 320px;
        overflow: auto;
      }

      /* Custom container */
      .container-narrow {
        margin: 0 auto;
        max-width: 700px;
      }
      .container-narrow > hr {
        margin: 10px 0 20px;
      }

      .b-ya-likes {
        display: inline-block;
        padding-left: 20px;
        vertical-align: top;
      }
    </style>

    <title>Sklad: IndexedDB abstraction layer</title>
</head>
<body>

<div class="container-narrow">
    <h2>
        Sklad: IndexedDB abstraction layer
        <div class="b-ya-likes yashare-auto-init" data-yashareL10n="ru" data-yashareQuickServices="gplus,twitter" data-yashareTheme="counter" data-yashareType="medium"></div>
    </h2>
    <hr>

    <p class="lead">IndexedDB is <strong>HTML5 standard</strong> for a local database of records holding practically <strong>any kind of data - from simple numbers to even Blobs</strong>. It is not the same as a relational database which has tables with collections rows and columns. IndexedDB has databases, which have objects stores with data stored there. In fact IndexedDB is a NoSQL database similar to MongoDB and CouchDB. It can also search for data with indexes which you create when start working with the database.</p>
    <p class="lead">The problem of IndexedDB is following: its API is too geeky, unfamiliar and complicated. Sklad library allows you to build apps for modern browsers with IndexedDB in a simple and convenient way. This is not ORM - it's just a thin abstraction layer on top of IndexedDB native API.</p>

    <h3>How to start</h3>
    <hr>

    <p>Sklad library supports CommonJS, AMD (require.js) and global namespace module declaration syntax. Also sklad library needs Promise support. If your browser doesn't support promises you should also include promises <a href="https://github.com/jakearchibald/es6-promise">polyfill</a>. if you don't like promises you can use deprecated <a href="https://github.com/1999/sklad/releases">1.x branch</a> releases. <code>bower install sklad --save</code> or <a href="https://github.com/1999/sklad/blob/master/sklad.js">download</a> library and include into your project code. Now you can connect to IndexedDB databases using <code>sklad.open()</code>. More details <a href="https://github.com/1999/sklad/blob/master/docs/README_sklad_open.md">here</a>. Beware that all operations run faster if you use multiple object stores in one call instead of using multiple simple operations. This happens because each operation runs inside its own transaction.</p>
    <script src="https://gist.github.com/1999/ca2f4af78eafa050521f.js?file=sklad_open.js"></script>
    <button type="button" class="btn btn-default" data-id="sklad_open">Run example</button>
    <pre class="example" id="sklad_open" style="display: none"></pre>

    <h3>Insert one or multiple records</h3>
    <hr>
    <p>There are 4 types of storing your data in the object stores. You should choose which of them fits your needs and after this you should pass proper data in the <code>database.insert()</code>. More details <a href="https://github.com/1999/sklad/blob/master/docs/README_skladConnection_insert.md">here</a>.</p>
    <script src="https://gist.github.com/1999/ca2f4af78eafa050521f.js?file=conn_insert.js"></script>
    <button type="button" class="btn btn-default" data-id="conn_insert">Run example</button>
    <pre class="example" id="conn_insert" style="display: none"></pre>

    <h3>Upsert one or multiple records</h3>
    <hr>
    <script src="https://gist.github.com/1999/ca2f4af78eafa050521f.js?file=conn_upsert.js"></script>
    <button type="button" class="btn btn-default" data-id="conn_upsert">Run example</button>
    <pre class="example" id="conn_upsert" style="display: none"></pre>

    <h3>Delete one or mutiple records</h3>
    <hr>
    <script src="https://gist.github.com/1999/ca2f4af78eafa050521f.js?file=conn_delete.js"></script>
    <button type="button" class="btn btn-default" data-id="conn_delete">Run example</button>
    <pre class="example" id="conn_delete" style="display: none"></pre>

    <h3>Clear one or multiple object stores</h3>
    <hr>
    <script src="https://gist.github.com/1999/ca2f4af78eafa050521f.js?file=conn_clear.js"></script>
    <button type="button" class="btn btn-default" data-id="conn_clear">Run example</button>
    <pre class="example" id="conn_clear" style="display: none"></pre>

    <h3>Get records from the object store(s)</h3>
    <hr>
    <p>You can specify your own ranges with native <a href="https://developer.mozilla.org/en-US/docs/IndexedDB/IDBKeyRange">IDBKeyRange</a> API. There's no opportunity to get limited number of records and total records number in one call. Default iterating direction is increasing in the order of keys including duplicates, but you can also set your own direction. More details <a href="https://github.com/1999/sklad/blob/master/docs/README_skladConnection_get.md">here</a>.</p>
    <script src="https://gist.github.com/1999/ca2f4af78eafa050521f.js?file=conn_get.js"></script>
    <button type="button" class="btn btn-default" data-id="conn_get">Run example</button>
    <pre class="example" id="conn_get" style="display: none"></pre>

    <h3>Count objects in the object store(s)</h3>
    <hr>
    <script src="https://gist.github.com/1999/ca2f4af78eafa050521f.js?file=conn_count.js"></script>
    <button type="button" class="btn btn-default" data-id="conn_count">Run example</button>
    <pre class="example" id="conn_count" style="display: none"></pre>

    <h3>Closing connection</h3>
    <hr>
    <p>Normally database connection is closed when use closes browser tabs. But if you want to do it explicitly <code>skladConnection.close()</code> method is at your service. More details <a href="https://github.com/1999/sklad/blob/master/docs/README_skladConnection_close.md">here</a>.</p>
    <script src="https://gist.github.com/1999/ca2f4af78eafa050521f.js?file=conn_close.js"></script>
    <button type="button" class="btn btn-default" data-id="conn_close">Run example</button>
    <pre class="example" id="conn_close" style="display: none"></pre>

    <hr>

    <div class="footer">
        <p>&copy; <a href="http://staypositive.ru">Dmitry Sorin</a> 2013-2014</p>
    </div>
</div>

<a href="https://github.com/1999/sklad"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"></a>

</body>
</html>
